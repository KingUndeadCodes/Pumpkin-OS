#include "../pit/pit.h"
#include <tasking.h>
#include "speaker.h"

static void PlaySound(uint32_t nFrequence) {
    uint32_t x;
    uint8_t y;
    x = 1193180 / nFrequence;
    outb(0x43, 0xb6);
    outb(0x42, (uint8_t)(x));
    outb(0x42, (uint8_t)(x >> 8));
    y = inb(0x61);
    if (y != (y | 3)) {
 	    outb(0x61, y | 3);
    }
}

static void Quiet() {
    uint8_t x = inb(0x61) & 0xFC;
    outb(0x61, x);
}

void beep(uint32_t freq = 950, uint32_t time = 18) {
    if (time == 0) {
        print("beep warning: 'time' played is zero.", COLOR_YELLOW);
        return;
    }
    PlaySound(freq);
    timer_wait(time);
    Quiet();
}

/*
void never_gonna(void) {
    // https://create.arduino.cc/projecthub/410027/rickroll-piezo-buzzer-a1cd11?ref=part&ref_id=8233&offset=3
    const int song1_intro_melody[] = {554, 622, 622, 698, 831, 740, 698, 622, 554, 622, -1, 415, 415};
    const int song1_intro_rhythmn[] = {6, 10, 6, 6, 1, 1, 1, 1, 6, 10, 4, 2, 10};
    const int song1_verse1_melody[] = {-1, 277, 277, 277, 277, 311, -1, 261, 233, 208, -1, 233, 233, 261, 277, 208, 415, 415, 311, -1, 233, 233, 261, 277, 233, 277, 311, -1, 261, 233, 233, 208, -1, 233, 233, 261, 277, 208, 208, 311, 311, 311, 349, 311, 277, 311, 349, 277, 311, 311, 311, 349, 311, 208, -1, 233, 261, 277, 208, -1, 311, 349, 311};
    const int song1_verse1_rhythmn[] = {2, 1, 1, 1, 1, 2, 1, 1, 1, 5, 1, 1, 1, 1, 3, 1, 2, 1, 5, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 3, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 4, 5, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 3, 1, 1, 1, 3};
    for (int i = 0; i < 13; i += 1) song1_intro_melody[i] == -1 ? timer_wait(song1_intro_rhythmn[i]) : beep((uint32_t)song1_intro_melody[i], (uint32_t)song1_intro_rhythmn[i]);
    for (int i = 0; i / sizeof(int) < sizeof(song1_intro_melody) / sizeof(int); i += 1) song1_verse1_melody[i] == -1 ? timer_wait(song1_verse1_rhythmn[i]) : beep((uint32_t)song1_verse1_melody[i], (uint32_t)song1_verse1_rhythmn[i] * 3);
}

#define NOTE_F4  349
#define NOTE_FS4 370
#define NOTE_G4  392
#define NOTE_GS4 415
#define NOTE_A4  440
#define NOTE_AS4 466
#define NOTE_C5  523
#define NOTE_C6  1047
#define NOTE_CS6 1109
#define NOTE_D5  587
#define NOTE_AS5 932
#define NOTE_CS5 554
#define NOTE_DS5 622
#define NOTE_E5  659
#define NOTE_F5  698
#define NOTE_FS5 740
#define NOTE_G5  784
#define NOTE_GS5 831
#define NOTE_A5  880
#define NOTE_AS5 932
#define NOTE_B5  988

const short melody[] = {
    NOTE_AS4,-2,  NOTE_F4,8,  NOTE_F4,8,  NOTE_AS4,8,//1
    NOTE_GS4,16,  NOTE_FS4,16,  NOTE_GS4,-2,
    NOTE_AS4,-2,  NOTE_FS4,8,  NOTE_FS4,8,  NOTE_AS4,8,
    NOTE_A4,16,  NOTE_G4,16,  NOTE_A4,-2,
    1, 
    NOTE_AS4,4,  NOTE_F4,-4,  NOTE_AS4,8,  NOTE_AS4,16,  NOTE_C5,16, NOTE_D5,16, NOTE_DS5,16,//7
    NOTE_F5,2,  NOTE_F5,8,  NOTE_F5,8,  NOTE_F5,8,  NOTE_FS5,16, NOTE_GS5,16,
    NOTE_AS5,-2,  NOTE_AS5,8,  NOTE_AS5,8,  NOTE_GS5,8,  NOTE_FS5,16,
    NOTE_GS5,-8,  NOTE_FS5,16,  NOTE_F5,2,  NOTE_F5,4, 
    NOTE_DS5,-8, NOTE_F5,16, NOTE_FS5,2, NOTE_F5,8, NOTE_DS5,8, //11
    NOTE_CS5,-8, NOTE_DS5,16, NOTE_F5,2, NOTE_DS5,8, NOTE_CS5,8,
    NOTE_C5,-8, NOTE_D5,16, NOTE_E5,2, NOTE_G5,8, 
    NOTE_F5,16, NOTE_F4,16, NOTE_F4,16, NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,8, NOTE_F4,16,NOTE_F4,8,
    NOTE_AS4,4,  NOTE_F4,-4,  NOTE_AS4,8,  NOTE_AS4,16,  NOTE_C5,16, NOTE_D5,16, NOTE_DS5,16,//15
    NOTE_F5,2,  NOTE_F5,8,  NOTE_F5,8,  NOTE_F5,8,  NOTE_FS5,16, NOTE_GS5,16,
    NOTE_AS5,-2, NOTE_CS6,4,
    NOTE_C6,4, NOTE_A5,2, NOTE_F5,4,
    NOTE_FS5,-2, NOTE_AS5,4,
    NOTE_A5,4, NOTE_F5,2, NOTE_F5,4,
    NOTE_FS5,-2, NOTE_AS5,4,
    NOTE_A5,4, NOTE_F5,2, NOTE_D5,4,
    NOTE_DS5,-2, NOTE_FS5,4,
    NOTE_F5,4, NOTE_CS5,2, NOTE_AS4,4,
    NOTE_C5,-8, NOTE_D5,16, NOTE_E5,2, NOTE_G5,8, 
    NOTE_F5,16, NOTE_F4,16, NOTE_F4,16, NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,16,NOTE_F4,8, NOTE_F4,16,NOTE_F4,8
};

const uint32_t d1[] PROGMEM = {
0,0,0,0,0,0,0,13913,14103,14130,14320,14347,14538,14565,14755,14782,15190,15217,15407,15434,15624,15652,16059,16086,16494,16521,16711,16739,16929,16956,17146,17173,17364,17391,17581,17608,17798,17826,18016,18043,18233,18260,18668,18695,18885,18913,19103,19130,19320,19347,19538,19565,19755,19782,19972,19999,20190,20217,20407,20434,20624,20652,20842,20869,21059,21086,21277,21304,21494,21521,21711,21739,22146,22173,22364,22391,22581,22608,23016,23043,23451,23478,23668,23695,23885,23913,24103,24130,24320,24347,24538,24565,24755,24782,24972,24999,25190,25217,25624,25652,25842,25869,26059,26086,26494,26521,26929,26956,27364,27391,27798,27826,28016,28043,28233,28260,28451,28478,28668,28695,29103,29130,29320,29347,29538,29565,29972,29999,30407,30434,30624,30652,30842,30869,31059,31086,31277,31304,31494,31521,31711,31739,31929,31956,32146,32173,32581,32608,32798,32826,33016,33043,33233,33260,33451,33478,33668,33695,33885,33912,34103,34130,34320,34347,34537,34565,34755,34782,34972,34999,35190,35217,35407,35434,35624,35652,36059,36086,36277,36304,36494,36521,36929,36956,37364,37391,37581,37608,37798,37826,38016,38043,38233,38260,38451,38478,38668,38695,38885,38912,39103,39130,39537,39565,39755,39782,39972,39999,40407,40434,40842,40869,41277,41304,41711,41739,41929,41956,42146,42173,42364,42391,42581,42608,43016,43043,43233,43260,43451,43478,43668,43695,43885,43912,44103,44130,44320,44347,44755,44782,44972,44999,45190,45217,45407,45434,45624,45652,45842,45869,46059,46086,46494,46521,46711,46739,46929,46956,47146,47173,47364,47391,47581,47608,47798,47826,48233,48260,48451,48478,48668,48695,48885,48912,49103,49130,49320,49347,49537,49565,49972,49999,50190,50217,50407,50434,50624,50652,50842,50869,51059,51086,51277,51304,51711,51739,51929,51956,52146,52173,52364,52391,52581,52608,52798,52826,53016,53043,53451,53478,53668,53695,53885,53912,54103,54130,54320,54347,54537,54565,54755,54782,55190,55217,55407,55434,55624,55652,55842,55869,56059,56086,56277,56304,56494,56521,56929,56956,57146,57173,57364,57391,57581,57608,57798,57826,58016,58043,58233,58260,58668,58695,58885,58912,59103,59130,59320,59347,59537,59565,59755,59782,59972,59999,60407,60434,60624,60652,60842,60869,61059,61086,61277,61304,61494,61521,61711,61739,62146,62173,62364,62391,62581,62608,62798,62825,63016,63043,63233,63260,63450,63478,63885,63912,64103,64130,64320,64347,64537,64565,64755,64782,64972,64999,65190,65217,65624,65652,65842,65869,66059,66086,66277,66304,66494,66521,66711,66739,66929,66956,67364,67391,67581,67608,67798,67825,68016,68043,68233,68260,68450,68478,68668,68695,68885,69130,69320,69347,69537,69565,69755,69782,69972,69999,70190,70217,70407,70434,70842,70869,71059,71086,71277,71304,71494,71521,71711,71739,71929,71956,72146,72173,72581,72608,72798,72825,73016,73043,73233,73260,73450,73478,73668,73695,73885,73912,74320,74347,74537,74565,74755,74782,74972,74999,75190,75217,75407,75434,75624,75652,76059,76086,76277,76304,76494,76521,76711,76739,76929,76956,77146,77173,77364,77391,77798,77825,78016,78043,78233,78260,78450,78478,78668,78695,78885,78912,79103,79130,79537,79565,79755,79782,79972,79999,80190,80217,80407,80434,80624,80652,80842,80869,81277,81304,81494,81521,81711,81739,81929,81956,82146,82173,82364,82391,82581,82608,83016,83043,83233,83260,83450,83478,83668,83695,83885,83912,84103,84130,84320,84347,84755,84782,84972,84999,85190,85217,85407,85434,85624,85652,85842,85869,86059,86086,86494,86521,86711,86739,86929,86956,87146,87173,87364,87391,87581,87608,87798,87825,88233,88260,88450,88478,88668,88695,88885,88912,89103,89130,89320,89347,89537,89565,89972,89999,90190,90217,90407,90434,90624,90652,90842,90869,91059,91086,91277,91304,91711,91739,91929,91956,92146,92173,92364,92391,92581,92608,92798,92825,93016,93043,93450,93478,93668,93695,93885,93912,94103,94130,94320,94347,94537,94565,94755,94782,95190,95217,95407,95434,95624,95652,95842,95869,96059,96086,96277,96304,96494,96521,96711,111299,111304,111489,111494,111521,111711,111738,111929,111956,112146,112173,112581,112608,112798,112825,113016,113043,113450,113478,113885,113912,114103,114130,114320,114347,114537,114565,114755,114782,114972,114999,115190,115217,115407,115434,115624,115652,116059,116086,116277,116304,116494,116521,116711,116738,116929,116956,117146,117173,117363,117391,117581,117608,117798,117825,118016,118043,118233,118260,118450,118478,118668,118695,118885,118912,119103,119130,119537,119565,119755,119782,119972,119999,120407,120434,120842,120869,121059,121086,121277,121304,121494,121521,121711,121738,121929,121956,122146,122173,122363,122391,122581,122608,123016,123043,123233,123260,123450,123478,123885,123912,124320,124347,124755,124782,125190,125217,125407,125434,125624,125651,125842,125869,126059,126086,126494,126521,126711,126738,126929,126956,127363,127391,127798,127825,128016,128043,128233,128260,128450,128478,128668,128695,128885,128912,129103,129130,129320,129347,129537,129565,129972,129999,130190,130217,130407,130434,130624,130651,130842,130869,131059,131086,131276,131304,131494,131521,131711,131738,131929,131956,132146,132173,132363,132391,132581,132608,132798,132825,133016,133043,133450,133478,133668,133695,133885,133912,134320,134347,134755,134782,134972,134999,135190,135217,135407,135434,135624,135651,135842,135869,136059,136086,136276,136304,136494,136521,136929,136956,137146,137173,137363,137391,137798,137825,138233,138260,138668,138695,139103,139130,139320,139347,139537,139565,139755,139782,139972,139999,140407,140434,140624,140651,140842,140869,141059,141086,141276,141304,141494,141521,141711,141738,142146,142173,142363,142391,142581,142608,142798,142825,143016,143043,143233,143260,143450,143478,143885,143912,144103,144130,144320,144347,144537,144565,144755,144782,144972,144999,145190,145217,145624,145651,145842,145869,146059,146086,146276,146304,146494,146521,146711,146738,146929,146956,147363,147391,147581,147608,147798,147825,148016,148043,148233,148260,148450,148478,148668,148695,149103,149130,149320,149347,149537,149565,149755,149782,149972,149999,150190,150217,150407,150434,150842,150869,151059,151086,151276,151304,151494,151521,151711,151738,151929,151956,152146,152173,152581,152608,152798,152825,153016,153043,153233,153260,153450,153478,153668,153695,153885,153912,154320,154347,154537,154565,154755,154782,154972,154999,155189,155217,155407,155434,155624,155651,156059,156086,156276,156304,156494,156521,156711,156738,156929,156956,157146,157173,157363,157391,157798,157825,158016,158043,158233,158260,158450,158478,158668,158695,158885,158912,159103,159130,159537,159564,159755,159782,159972,159999,160189,160217,160407,160434,160624,160651,160842,160869,161276,161304,161494,161521,161711,161738,161929,161956,162146,162173,162363,162391,162581,162608,163016,163043,163233,163260,163450,163478,163668,163695,163885,163912,164103,164130,164320,164347,164755,164782,164972,164999,165189,165217,165407,165434,165624,165651,165842,165869,166059,166086,166276,166521,166711,166738,166929,166956,167146,167173,167363,167391,167581,167608,167798,167825,168233,168260,168450,168478,168668,168695,168885,168912,169103,169130,169320,169347,169537,169564,169972,169999,170189,170217,170407,170434,170624,170651,170842,170869,171059,171086,171276,171304,171711,171738,171929,171956,172146,172173,172363,172391,172581,172608,172798,172825,173016,173043,173450,173478,173668,173695,173885,173912,174103,174130,174320,174347,174537,174564,174755,174782,175189,175217,175407,175434,175624,175651,175842,175869,176059,176086,176276,176304,176494,176521,176929,176956,177146,177173,177363,177391,177581,177608,177798,177825,178016,178043,178233,178260,178668,178695,178885,178912,179103,179130,179320,179347,179537,179564,179755,179782,179972,179999,180407,180434,180624,180651,180842,180869,181059,181086,181276,181304,181494,181521,181711,181738,182146,182173,182363,182391,182581,182608,182798,182825,183016,183043,183233,183260,183450,183478,183885,183912,184103,184130,184320,184347,184537,184564,184755,184782,184972,184999,185189,185217,185624,185651,185842,185869,186059,186086,186276,186304,186494,186521,186711,186738,186929,186956,187363,187391,187581,187608,187798,187825,188016,188043,188233,188260,188450,188477,188668,188695,189102,189130,189320,189347,189537,189564,189755,189782,189972,189999,190189,190217,190407,190434,190842,190869,191059,191086,191276,191304,191494,191521,191711,191738,191929,191956,192146,192173,192581,192608,192798,192825,193016,193043,193233,193260,193450,193477,193668,193695,193885,193912,194755,199999,199999,200004,
};


void Zelda(void) {
    for (int i = 0; i < 219; i++) {
        PlaySound(melody[i]);
        // timer_wait(wholenote / melody[i]);
        timer_wait(2);
        Quiet();
    }
}
*/